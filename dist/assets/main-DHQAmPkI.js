(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();class d{constructor(){this.keyPair=null,this.sharedKey=null,this.initializeKeys()}async initializeKeys(){try{this.keyPair=await window.crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!1,["deriveKey"]),this.sharedKey=await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),console.log("Encryption keys initialized")}catch(e){console.error("Failed to initialize encryption keys:",e)}}async encryptMessage(e){if(!this.sharedKey)return console.warn("Encryption key not ready, sending unencrypted"),e;try{const n=new TextEncoder().encode(e),a=window.crypto.getRandomValues(new Uint8Array(12)),i=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},this.sharedKey,n),s=new Uint8Array(a.length+i.byteLength);return s.set(a),s.set(new Uint8Array(i),a.length),btoa(String.fromCharCode(...s))}catch(t){return console.error("Encryption failed:",t),e}}async decryptMessage(e){if(!this.sharedKey)return console.warn("Decryption key not ready, returning as-is"),e;try{const t=new Uint8Array(atob(e).split("").map(o=>o.charCodeAt(0))),n=t.slice(0,12),a=t.slice(12),i=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:n},this.sharedKey,a);return new TextDecoder().decode(i)}catch(t){return console.error("Decryption failed:",t),e}}generateRoomId(){const e=new Uint8Array(16);return window.crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}async hashData(e){const n=new TextEncoder().encode(e),a=await window.crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(a)).map(s=>s.toString(16).padStart(2,"0")).join("")}}class h{constructor(){this.localStream=null,this.remoteStream=null,this.peerConnection=null,this.dataChannel=null,this.isCallActive=!1,this.isMuted=!1,this.isCameraOff=!1,this.callStartTime=null,this.callTimer=null,this.encryptionKey=null,this.isInitiator=!1,this.signalingData=new Map,this.initializeWebRTC(),this.initializeEncryption()}async initializeWebRTC(){this.rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"},{urls:"stun:stun.nextcloud.com:443"}],iceCandidatePoolSize:10,iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}}async initializeEncryption(){try{this.encryptionKey=await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),console.log("Call encryption initialized")}catch(e){console.error("Failed to initialize call encryption:",e)}}async startCall(e=!1,t=null){try{this.isInitiator=!0;const n={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1,googTypingNoiseDetection:!1},video:e?{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30},googNoiseReduction:!1}:!1};if(this.localStream=await navigator.mediaDevices.getUserMedia(n),e){const s=document.getElementById("localVideo");s&&(s.srcObject=this.localStream)}this.peerConnection=new RTCPeerConnection(this.rtcConfig),this.dataChannel=this.peerConnection.createDataChannel("encrypted-metadata",{ordered:!0,protocol:"encrypted"}),this.setupDataChannel(this.dataChannel),this.localStream.getTracks().forEach(s=>{const o=this.peerConnection.addTrack(s,this.localStream);if(o.getParameters){const r=o.getParameters();r.encodings&&(r.encodings.forEach(l=>{l.rid=void 0,l.networkPriority="high"}),o.setParameters(r))}}),this.peerConnection.ontrack=s=>{if(this.remoteStream=s.streams[0],e){const o=document.getElementById("remoteVideo");o&&(o.srcObject=this.remoteStream)}console.log("Remote stream received (encrypted)")},this.peerConnection.ondatachannel=s=>{const o=s.channel;this.setupDataChannel(o)},this.peerConnection.onicecandidate=async s=>{if(s.candidate){const o=await this.encryptSignalingData({type:"ice-candidate",candidate:s.candidate,timestamp:Date.now()});t&&t.readyState===WebSocket.OPEN&&t.send(JSON.stringify({type:"encrypted_signaling",data:o,ephemeral:!0}))}},this.peerConnection.onconnectionstatechange=()=>{console.log("Connection state:",this.peerConnection.connectionState),this.peerConnection.connectionState==="connected"?this.onCallConnected():(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed")&&this.handleCallDisconnection()};const a=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:e,voiceActivityDetection:!1});await this.peerConnection.setLocalDescription(a);const i=await this.encryptSignalingData({type:"offer",offer:a,isVideo:e,timestamp:Date.now()});t&&t.readyState===WebSocket.OPEN&&t.send(JSON.stringify({type:"encrypted_signaling",data:i,ephemeral:!0})),this.isCallActive=!0,this.startCallTimer(),document.getElementById("callStatus").textContent="Connecting securely...",console.log("Encrypted call initiated")}catch(n){console.error("Failed to start encrypted call:",n),this.handleCallError("Failed to access camera/microphone")}}async handleEncryptedSignaling(e,t){try{const n=await this.decryptSignalingData(e);switch(n.type){case"offer":await this.handleOffer(n,t);break;case"answer":await this.handleAnswer(n);break;case"ice-candidate":await this.handleIceCandidate(n);break}}catch(n){console.error("Failed to handle encrypted signaling:",n)}}async handleOffer(e,t){if(!this.peerConnection){this.peerConnection=new RTCPeerConnection(this.rtcConfig);const i={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1},video:e.isVideo?{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30},googNoiseReduction:!1}:!1};if(this.localStream=await navigator.mediaDevices.getUserMedia(i),e.isVideo){const s=document.getElementById("localVideo");s&&(s.srcObject=this.localStream)}this.localStream.getTracks().forEach(s=>{this.peerConnection.addTrack(s,this.localStream)}),this.peerConnection.ontrack=s=>{if(this.remoteStream=s.streams[0],e.isVideo){const o=document.getElementById("remoteVideo");o&&(o.srcObject=this.remoteStream)}},this.peerConnection.ondatachannel=s=>{this.setupDataChannel(s.channel)},this.peerConnection.onicecandidate=async s=>{if(s.candidate){const o=await this.encryptSignalingData({type:"ice-candidate",candidate:s.candidate,timestamp:Date.now()});t&&t.readyState===WebSocket.OPEN&&t.send(JSON.stringify({type:"encrypted_signaling",data:o,ephemeral:!0}))}}}await this.peerConnection.setRemoteDescription(e.offer);const n=await this.peerConnection.createAnswer({voiceActivityDetection:!1});await this.peerConnection.setLocalDescription(n);const a=await this.encryptSignalingData({type:"answer",answer:n,timestamp:Date.now()});t&&t.readyState===WebSocket.OPEN&&t.send(JSON.stringify({type:"encrypted_signaling",data:a,ephemeral:!0})),this.isCallActive=!0,this.startCallTimer()}async handleAnswer(e){this.peerConnection&&await this.peerConnection.setRemoteDescription(e.answer)}async handleIceCandidate(e){this.peerConnection&&await this.peerConnection.addIceCandidate(e.candidate)}setupDataChannel(e){e.onopen=()=>{console.log("Encrypted data channel opened")},e.onmessage=async t=>{try{const n=JSON.parse(t.data),a=await this.decryptChannelData(n);this.handleChannelMessage(a)}catch(n){console.error("Failed to decrypt channel data:",n)}},e.onclose=()=>{console.log("Encrypted data channel closed")}}async sendChannelMessage(e){if(this.dataChannel&&this.dataChannel.readyState==="open"){const t=await this.encryptChannelData(e);this.dataChannel.send(JSON.stringify(t))}}handleChannelMessage(e){switch(e.type){case"mute_status":console.log("Remote peer mute status:",e.isMuted);break;case"camera_status":console.log("Remote peer camera status:",e.isCameraOff);break}}onCallConnected(){document.getElementById("callStatus").textContent="Connected (Encrypted)",this.sendChannelMessage({type:"connection_established",timestamp:Date.now()})}handleCallDisconnection(){console.log("Call disconnected"),this.endCall()}endCall(){this.localStream&&(this.localStream.getTracks().forEach(n=>{n.stop(),n.enabled=!1}),this.localStream=null),this.remoteStream&&(this.remoteStream.getTracks().forEach(n=>{n.stop()}),this.remoteStream=null),this.dataChannel&&(this.dataChannel.close(),this.dataChannel=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.signalingData.clear(),this.isCallActive=!1,this.stopCallTimer();const e=document.getElementById("localVideo"),t=document.getElementById("remoteVideo");e&&(e.srcObject=null),t&&(t.srcObject=null),window.gc&&window.gc(),console.log("Call ended - all traces cleared")}toggleMute(){if(this.localStream){const e=this.localStream.getAudioTracks()[0];if(e)return e.enabled=!e.enabled,this.isMuted=!e.enabled,this.sendChannelMessage({type:"mute_status",isMuted:this.isMuted,timestamp:Date.now()}),this.isMuted}return!1}toggleCamera(){if(this.localStream){const e=this.localStream.getVideoTracks()[0];if(e)return e.enabled=!e.enabled,this.isCameraOff=!e.enabled,this.sendChannelMessage({type:"camera_status",isCameraOff:this.isCameraOff,timestamp:Date.now()}),this.isCameraOff}return!1}startCallTimer(){this.callStartTime=Date.now(),this.callTimer=setInterval(()=>{const e=Date.now()-this.callStartTime,t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3),a=document.getElementById("callTimer");a&&(a.textContent=`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`)},1e3)}stopCallTimer(){this.callTimer&&(clearInterval(this.callTimer),this.callTimer=null);const e=document.getElementById("callTimer");e&&(e.textContent="00:00")}async encryptSignalingData(e){if(!this.encryptionKey)return e;try{const t=new TextEncoder,n=JSON.stringify(e),a=t.encode(n),i=window.crypto.getRandomValues(new Uint8Array(12)),s=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:i},this.encryptionKey,a),o=new Uint8Array(i.length+s.byteLength);return o.set(i),o.set(new Uint8Array(s),i.length),btoa(String.fromCharCode(...o))}catch(t){return console.error("Signaling encryption failed:",t),e}}async decryptSignalingData(e){if(!this.encryptionKey)return e;try{const t=new Uint8Array(atob(e).split("").map(r=>r.charCodeAt(0))),n=t.slice(0,12),a=t.slice(12),i=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:n},this.encryptionKey,a),o=new TextDecoder().decode(i);return JSON.parse(o)}catch(t){return console.error("Signaling decryption failed:",t),e}}async encryptChannelData(e){return this.encryptSignalingData(e)}async decryptChannelData(e){return this.decryptSignalingData(e)}handleCallError(e){console.error("Call error:",e),document.getElementById("callStatus").textContent="Call Failed",setTimeout(()=>{this.endCall(),document.getElementById("chatInterface").classList.remove("hidden"),document.getElementById("callInterface").classList.add("hidden")},3e3)}async startScreenShare(){try{const e=await navigator.mediaDevices.getDisplayMedia({video:{cursor:"never",displaySurface:"window"},audio:!1});if(this.peerConnection){const t=e.getVideoTracks()[0],n=this.peerConnection.getSenders().find(a=>a.track&&a.track.kind==="video");n&&await n.replaceTrack(t)}return e.getVideoTracks()[0].onended=()=>{this.stopScreenShare()},this.sendChannelMessage({type:"screen_share_started",timestamp:Date.now()}),!0}catch(e){return console.error("Screen share failed:",e),!1}}async stopScreenShare(){if(this.localStream&&this.peerConnection){const e=this.localStream.getVideoTracks()[0],t=this.peerConnection.getSenders().find(n=>n.track&&n.track.kind==="video");t&&e&&await t.replaceTrack(e)}this.sendChannelMessage({type:"screen_share_stopped",timestamp:Date.now()})}}class u{constructor(){this.wss=null,this.currentGroupId=null,this.cryptoManager=new d,this.voiceManager=new h,this.isTyping=!1,this.typingTimeout=null,this.initializeElements(),this.bindEvents(),this.connectWebSocket()}initializeElements(){this.welcomeScreen=document.getElementById("welcomeScreen"),this.chatInterface=document.getElementById("chatInterface"),this.callInterface=document.getElementById("callInterface"),this.createGroupBtn=document.getElementById("createGroupBtn"),this.joinGroupBtn=document.getElementById("joinGroupBtn"),this.groupIdInput=document.getElementById("groupIdInput"),this.messagesContainer=document.getElementById("messagesContainer"),this.messageInput=document.getElementById("messageInput"),this.sendBtn=document.getElementById("sendBtn"),this.currentGroupIdSpan=document.getElementById("currentGroupId"),this.connectionStatus=document.getElementById("connectionStatus"),this.typingIndicator=document.getElementById("typingIndicator"),this.leaveGroupBtn=document.getElementById("leaveGroupBtn"),this.voiceCallBtn=document.getElementById("voiceCallBtn"),this.videoCallBtn=document.getElementById("videoCallBtn"),this.screenShareBtn=document.getElementById("screenShareBtn"),this.callStatus=document.getElementById("callStatus"),this.callTimer=document.getElementById("callTimer"),this.muteBtn=document.getElementById("muteBtn"),this.endCallBtn=document.getElementById("endCallBtn"),this.cameraBtn=document.getElementById("cameraBtn")}bindEvents(){this.createGroupBtn.addEventListener("click",()=>this.createGroup()),this.joinGroupBtn.addEventListener("click",()=>this.joinGroup()),this.groupIdInput.addEventListener("keypress",t=>{t.key==="Enter"&&this.joinGroup()}),this.sendBtn.addEventListener("click",()=>this.sendMessage()),this.messageInput.addEventListener("keypress",t=>{t.key==="Enter"?this.sendMessage():this.handleTyping()}),this.leaveGroupBtn.addEventListener("click",()=>this.leaveGroup()),this.voiceCallBtn.addEventListener("click",()=>this.startVoiceCall()),this.videoCallBtn.addEventListener("click",()=>this.startVideoCall()),this.screenShareBtn.addEventListener("click",()=>this.toggleScreenShare()),this.endCallBtn.addEventListener("click",()=>this.endCall()),this.muteBtn.addEventListener("click",()=>this.toggleMute()),this.cameraBtn.addEventListener("click",()=>this.toggleCamera());const e=document.getElementById("deleteAllBtn");e&&e.addEventListener("click",()=>this.deleteAllMessages()),window.chatApp=this}connectWebSocket(){this.updateConnectionStatus("connecting"),this.wss=new WebSocket(`wss://${window.location.host}/wss`),this.wss.onopen=()=>{console.log("WebSocket connected"),this.updateConnectionStatus("connected")},this.wss.onmessage=e=>{const t=JSON.parse(e.data);this.handleWebSocketMessage(t)},this.wss.onclose=()=>{console.log("WebSocket disconnected"),this.updateConnectionStatus("disconnected"),setTimeout(()=>this.connectWebSocket(),3e3)},this.wss.onerror=e=>{console.error("WebSocket error:",e),this.updateConnectionStatus("disconnected")}}handleWebSocketMessage(e){switch(e.type){case"group_created":this.currentGroupId=e.groupId,this.showChatInterface(),this.copyGroupIdToClipboard();break;case"joined_group":this.currentGroupId=e.groupId,this.showChatInterface();break;case"chat_message":this.displayMessage(e);break;case"call_allowed":this.voiceManager.startCall(e.callType==="video",this.ws);break;case"encrypted_signaling":this.voiceManager.handleEncryptedSignaling(e.data,this.wss);break;case"error":this.showError(e.message);break;default:console.log("Unknown message type:",e.type)}}createGroup(){this.wss&&this.wss.readyState===WebSocket.OPEN?this.wss.send(JSON.stringify({type:"create_group"})):this.showError("Not connected to server")}joinGroup(){const e=this.groupIdInput.value.trim();if(!e){this.showError("Please enter a room ID");return}this.wss&&this.wss.readyState===WebSocket.OPEN?this.wss.send(JSON.stringify({type:"join_group",groupId:e})):this.showError("Not connected to server")}async sendMessage(){const e=this.messageInput.value.trim();if(!e)return;const t=await this.cryptoManager.encryptMessage(e);this.wss&&this.wss.readyState===WebSocket.OPEN&&(this.wss.send(JSON.stringify({type:"chat_message",content:t})),this.displayOwnMessage(e),this.messageInput.value="")}async displayMessage(e){try{const t=await this.cryptoManager.decryptMessage(e.content),n=document.createElement("div");n.className="message-bubble bg-white bg-opacity-20 rounded-lg p-3 max-w-xs mr-auto relative group";const a=new Date(e.timestamp).toLocaleTimeString(),i="msg-"+e.timestamp+"-"+e.sender;n.id=i,n.innerHTML=`
                <div class="text-white text-sm">${this.escapeHtml(t)}</div>
                <div class="text-blue-200 text-xs mt-1">${a}</div>
                <button onclick="window.chatApp.deleteMessage('${i}')" 
                        class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center"
                        title="Delete message">
                    <i class="fas fa-times"></i>
                </button>
            `,this.messagesContainer.appendChild(n),this.scrollToBottom(),setTimeout(()=>{n.parentNode&&n.remove()},36e5)}catch(t){console.error("Failed to decrypt message:",t)}}displayOwnMessage(e){const t=document.createElement("div");t.className="message-bubble bg-blue-600 rounded-lg p-3 max-w-xs ml-auto relative group";const n=new Date().toLocaleTimeString(),a="msg-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);t.id=a,t.innerHTML=`
            <div class="text-white text-sm">${this.escapeHtml(e)}</div>
            <div class="text-blue-200 text-xs mt-1">${n} • You</div>
            <button onclick="window.chatApp.deleteMessage('${a}')" 
                    class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center"
                    title="Delete message">
                <i class="fas fa-times"></i>
            </button>
        `,this.messagesContainer.appendChild(t),this.scrollToBottom(),setTimeout(()=>{t.parentNode&&t.remove()},36e5)}handleTyping(){this.isTyping||(this.isTyping=!0),clearTimeout(this.typingTimeout),this.typingTimeout=setTimeout(()=>{this.isTyping=!1},1e3)}startVoiceCall(){this.wss&&this.wss.readyState===WebSocket.OPEN&&this.wss.send(JSON.stringify({type:"start_call",callType:"voice"})),this.showCallInterface(!1)}startVideoCall(){this.wss&&this.wss.readyState===WebSocket.OPEN&&this.wss.send(JSON.stringify({type:"start_call",callType:"video"})),this.showCallInterface(!0)}endCall(){this.voiceManager.endCall(),this.showChatInterface()}toggleMute(){const e=this.voiceManager.toggleMute();this.muteBtn.innerHTML=e?'<i class="fas fa-microphone-slash"></i>':'<i class="fas fa-microphone"></i>'}toggleCamera(){const e=this.voiceManager.toggleCamera();this.cameraBtn.innerHTML=e?'<i class="fas fa-video-slash"></i>':'<i class="fas fa-video"></i>'}toggleScreenShare(){this.voiceManager.isCallActive?this.voiceManager.startScreenShare():this.showError("Start a call first to share your screen")}showChatInterface(){this.welcomeScreen.classList.add("hidden"),this.chatInterface.classList.remove("hidden"),this.callInterface.classList.add("hidden"),this.currentGroupIdSpan.textContent=this.currentGroupId,this.messageInput.focus()}showCallInterface(e){this.chatInterface.classList.add("hidden"),this.callInterface.classList.remove("hidden"),e?(document.getElementById("videoContainer").classList.remove("hidden"),this.cameraBtn.classList.remove("hidden")):(document.getElementById("videoContainer").classList.add("hidden"),this.cameraBtn.classList.add("hidden"))}leaveGroup(){this.currentGroupId=null,this.welcomeScreen.classList.remove("hidden"),this.chatInterface.classList.add("hidden"),this.messagesContainer.innerHTML="",this.groupIdInput.value=""}updateConnectionStatus(e){this.connectionStatus.className=`connection-status ${e}`}copyGroupIdToClipboard(){navigator.clipboard.writeText(this.currentGroupId).then(()=>{this.showSuccess("Room ID copied to clipboard! Share it with others to invite them.")})}scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}showError(e){alert("Error: "+e)}showSuccess(e){alert("Success: "+e)}deleteMessage(e){const t=document.getElementById(e);t&&(t.style.animation="fadeOut 0.3s ease-out",setTimeout(()=>{t.parentNode&&t.remove()},300))}deleteAllMessages(){confirm("Are you sure you want to delete all messages? This action cannot be undone.")&&this.messagesContainer.querySelectorAll(".message-bubble").forEach((t,n)=>{setTimeout(()=>{t.parentNode&&(t.style.animation="fadeOut 0.3s ease-out",setTimeout(()=>{t.parentNode&&t.remove()},300))},n*50)})}}document.addEventListener("DOMContentLoaded",()=>{new u});
